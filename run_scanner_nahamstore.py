from colorama import Fore, Style

from handlers.write_target import Writer
from vulnerability_scanner import Scanner

TARGET_LINKS_TO_WRITE = "LINKS_success"
TARGET_MEDIA_LINKS_TO_WRITE = "MEDIA_LINKS_success"


class ScanningLevels:
    EASY = "easy"  # Scans until the first payload found
    HARD = "hard"  # Scan for all payloads


class Case:
    XSS_IN_LINK = "xss_in_link"
    XSS_IN_FORM = "xss_in_form"
    XSS_IN_HEADER = "xss_in_header"
    COMMAND_IN_LINK = "command_in_link"
    COMMAND_IN_FORM = "command_in_form"
    HTML = "html"
    SQL_IN_LINK = "sql_in_link"
    SQL_IN_FORM = "sql_in_form"
    CSRF = "csrf"


def run_scaner(case, scanning_levels, requests_per_minute=None, collection_media_links=None):
    vulnerability_scanner = Scanner(TARGET_URL, LINKS_TO_IGNORE)
    vulnerability_scanner.login(LOGIN_URL, AUTHORIZATION_IN_LOGIN_FORM)
    # vulnerability_scanner.login_with_cookie(LOGIN_URL, AUTHORIZATION_IN_COOKIE)

    print(f"{Fore.GREEN}{Style.BRIGHT}\nCrawler Starts ðŸ§ ==>{Style.RESET_ALL}\n")
    vulnerability_scanner.crawl(collection_media_links)
    vulnerability_scanner.write_target_links(TARGET_LINKS_TO_WRITE, TARGET_MEDIA_LINKS_TO_WRITE)

    print(f"{Fore.GREEN}{Style.BRIGHT}\nVulnerability Scanner Starts ðŸ§ ==> {Style.RESET_ALL}\n")
    vulnerability_scanner.run_scanner(case=case,
                                      scanning_level=scanning_levels,
                                      req_per_minute=requests_per_minute)

    vulnerability_scanner.requests_per_minute()

    all_lists = vulnerability_scanner.get_all_lists()
    writer = Writer(all_lists)
    writer.write_target_success()


if __name__ == '__main__':
    TARGET_URL = "http://nahamstore.thm/"

    # TARGET_URL = "http://nahamstore.thm:8000/admin/"
    # TARGET_URL = "http://nahamstore.thm/product/picture/?file=5"
    # TARGET_URL = "http://marketing.nahamstore.thm/"

    LOGIN_URL = f"{TARGET_URL}login"

    LINKS_TO_IGNORE = [
        "http://nahamstore.thm/logout",
        'http://nahamstore.thm/account/settings/disable',

        # 'http://nahamstore.thm/',
        'http://nahamstore.thm/returns',
        'http://nahamstore.thm/login',
        'http://nahamstore.thm/register',
        'http://nahamstore.thm/account/orders',
        'http://nahamstore.thm/account/settings',
        'http://nahamstore.thm/account/addressbook',
        'http://nahamstore.thm/basket',
        'http://nahamstore.thm/account/settings/email',
        'http://nahamstore.thm/account/settings/password',
        'http://nahamstore.thm/product?id=2&name=Sticker+Pack',
        # 'http://nahamstore.thm/product?id=2',
        'http://nahamstore.thm/product?id=1&name=Hoodie+%2B+Tee',
        'http://nahamstore.thm/product?id=1'

    ]

    print(f"{Fore.RED}{Style.BRIGHT}ðŸ§ LINKS_TO_IGNORE: {Style.RESET_ALL}{LINKS_TO_IGNORE}\n")

    AUTHORIZATION_IN_LOGIN_FORM = {
        "login_email": 'test@test.com',
        "login_password": 'testpass',
        "Login": 'submit',
    }

    # TARGET_URL = "http://nahamstore.thm:8000/admin/login"
    # username=admin&password=admin
    # AUTHORIZATION_IN_LOGIN_FORM = {
    #     "username": 'admin',
    #     "password": 'admin',
    #     "Login": 'submit',
    # }


    AUTHORIZATION_IN_COOKIE = {
        'session': 'c6f912633be1910a386621ad62846c72',
        'token': 'e590d3331e89345558bde0655b8e19bd'
    }

    REQUESTS_PER_MINUTE = 5000  # def run_scaner --> requests_per_minute=None
    COLLECTION_MEDIA_LINKS = "Yes"

    run_scaner(case=[
        # Case.XSS_IN_LINK,
        # Case.XSS_IN_FORM,
        # Case.XSS_IN_HEADER,
        # Case.COMMAND_IN_LINK,
        # Case.COMMAND_IN_FORM,
        # Case.HTML,  # In developing
        Case.SQL_IN_LINK,  # In developing
        # Case.SQL_IN_FORM,  # In developing
        # Case.CSRF,
    ],
        scanning_levels=ScanningLevels.EASY,
        # requests_per_minute=REQUESTS_PER_MINUTE, # add REQUESTS_PER_MINUTE
        collection_media_links=COLLECTION_MEDIA_LINKS
    )
